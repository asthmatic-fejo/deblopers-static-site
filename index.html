<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Cuenta confirmada | Deb&Lopers</title>
  <style>
    :root { 
      color-scheme: light dark;
      --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-card: #ffffff10;
      --text-primary: #fff;
      --text-secondary: rgba(255,255,255,0.85);
      --border-color: #ffffff22;
      --success-color: #00dfa0;
      --warning-color: #ffbf4d;
      --error-color: #ff6b6b;
      --shadow: 0 10px 35px -8px rgba(0,0,0,.55);
    }
    
    [data-theme="light"] {
      --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-card: rgba(255,255,255,0.9);
      --text-primary: #333;
      --text-secondary: #666;
      --border-color: rgba(0,0,0,0.1);
      --shadow: 0 10px 35px -8px rgba(0,0,0,.15);
    }
    
    body { 
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; 
      margin:0; padding:0; display:flex; min-height:100dvh; 
      background: var(--bg-primary); 
      color: var(--text-primary); 
      transition: all 0.3s ease;
    }
    
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 50px;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .theme-toggle:hover {
      transform: scale(1.05);
    }
    
    .nav-link {
      position: absolute;
      top: 20px;
      left: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 25px;
      padding: 12px 20px;
      text-decoration: none;
      color: var(--text-primary);
      font-weight: bold;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .nav-link:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.2);
    }
    
    .card { 
      margin:auto; background: var(--bg-card); backdrop-filter:blur(10px); 
      padding:2.2rem 2.4rem; border-radius:18px; max-width:560px; width:100%; 
      box-shadow: var(--shadow); border:1px solid var(--border-color); position:relative; 
      transition: all 0.3s ease;
    }
    
    h1 { margin-top:0; font-size:1.9rem; line-height:1.15; }
    p { line-height:1.5; color: var(--text-secondary); }
    .ok { font-size:4rem; line-height:1; filter:drop-shadow(0 4px 10px rgba(0,255,128,.35)); }
    footer { margin-top:2rem; font-size:.72rem; opacity:.65; }
    code { background:#00000040; padding:.15rem .4rem; border-radius:4px; font-size:.85em; }
    .user-block { display:flex; align-items:center; gap:1rem; margin:1.2rem 0 1.4rem; }
    .avatar-wrapper { 
      width:82px; height:82px; border-radius:50%; overflow:hidden; 
      background: var(--bg-card); display:flex; align-items:center; justify-content:center; 
      border:1px solid var(--border-color); box-shadow:0 4px 15px -4px rgba(0,0,0,.5); 
    }
    .avatar-wrapper img { width:100%; height:100%; object-fit:cover; display:block; }
    .skeleton { background:linear-gradient(110deg,#ffffff20 8%,#ffffff05 18%,#ffffff20 33%); background-size:200% 100%; animation:shimmer 1.1s linear infinite; }
    @keyframes shimmer { to { background-position:-200% 0; } }
    .email { font-weight:600; font-size:1.05rem; word-break:break-all; }
    .tag { display:inline-block; background:#00c46a18; color: var(--success-color); padding:.25rem .55rem; font-size:.65rem; border:1px solid #00c46a55; border-radius:6px; letter-spacing:.5px; margin-left:.4rem; vertical-align:middle; }
    .hidden { display:none !important; }
    .warn { color: var(--warning-color); font-size:.75rem; margin-top:.35rem; }
    .error { color: var(--error-color); font-size:.8rem; margin-top:.75rem; }
  </style>
</head>
<body>
  <!-- Navegación a QR System -->
  <a href="qr/" class="nav-link">📱 QR Codes</a>
  
  <!-- Theme Toggle -->
  <div class="theme-toggle" onclick="toggleTheme()">
    <span id="theme-icon">🌙</span>
    <span id="theme-text">Dark</span>
  </div>

  <div class="card">
    <div class="ok">✅</div>
    <h1>¡Email confirmado!</h1>
    <p>Tu dirección de correo fue verificada correctamente. Ahora tu registro quedó en estado <strong>Pendiente</strong> hasta que un administrador revise tus datos.</p>

    <div id="userInfo" class="user-block hidden">
      <div class="avatar-wrapper skeleton" id="avatarSkeleton">
        <img id="avatarImg" alt="Avatar" style="display:none" />
      </div>
      <div style="flex:1">
        <div class="email" id="userEmail">(leyendo email ...)</div>
        <div id="avatarStatus" class="warn hidden">Buscando avatar...</div>
      </div>
    </div>

    <p id="genericMsg">Un supervisor revisará tu solicitud. Cuando te aprueben, podrás iniciar sesión en la aplicación móvil. ¡Mantén la app instalada y revisa las notificaciones!</p>
    <p style="font-size:.9rem; opacity:.85">Si esto no lo esperabas, ignora este mensaje. Este es el portal web de Deb&Lopers.</p>
    <div id="errorBox" class="error hidden"></div>
    <footer>
      Portal web de Deb&Lopers | <a href="qr/" style="color: var(--success-color);">Ver QR Codes del sistema</a>
    </footer>
  </div>
  
  <script>
    // Theme Management
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      // Update toggle button
      const icon = document.getElementById('theme-icon');
      const text = document.getElementById('theme-text');
      
      if (newTheme === 'light') {
        icon.textContent = '☀️';
        text.textContent = 'Light';
      } else {
        icon.textContent = '🌙';
        text.textContent = 'Dark';
      }
    }
    
    // Initialize theme
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      const icon = document.getElementById('theme-icon');
      const text = document.getElementById('theme-text');
      
      if (savedTheme === 'light') {
        icon.textContent = '☀️';
        text.textContent = 'Light';
      } else {
        icon.textContent = '🌙';
        text.textContent = 'Dark';
      }
    }

    // Original confirmed-mail logic (sin modificar)
    (function(){
      const projectRef = 'xnviizhgjwcurhncbivt'; // Cambiar si migras de proyecto
      const bucket = 'avatars';
      const el = (id)=>document.getElementById(id);
      const userInfo = el('userInfo');
      const emailEl = el('userEmail');
      const avatarImg = el('avatarImg');
      const avatarSkeleton = el('avatarSkeleton');
      const avatarStatus = el('avatarStatus');
      const errorBox = el('errorBox');

      function parseParams() {
        const out = {};
        const apply = (str)=>{
          if(!str) return; 
            str.replace(/^#/, '').split('&').forEach(kv=>{ if(!kv) return; const [k,v] = kv.split('='); if(k) out[decodeURIComponent(k)] = decodeURIComponent(v||''); });
        };
        apply(window.location.search.substring(1));
        apply(window.location.hash.substring(1));
        return out;
      }

      function base64UrlDecode(seg){
        seg = seg.replace(/-/g,'+').replace(/_/g,'/');
        const pad = seg.length % 4; if(pad) seg += '='.repeat(4-pad);
        try { return atob(seg); } catch { return null; }
      }

      function decodeJwt(token){
        const parts = token.split('.'); if(parts.length<2) return null; const json = base64UrlDecode(parts[1]); if(!json) return null; try { return JSON.parse(json); } catch { return null; }
      }

      function sanitizeEmail(email){
        return email.replace(/@/g,'-').replace(/\./g,'-');
      }

      async function tryAvatar(email, explicitUrl){
        avatarStatus.classList.remove('hidden');
        if(explicitUrl) {
          const ok = await loadImage(explicitUrl);
          if(ok) return explicitUrl;
        }
        const base = `https://${projectRef}.supabase.co/storage/v1/object/public/${bucket}/`;
        const baseName = sanitizeEmail(email);
        const candidates = [base+baseName+'.png', base+baseName+'.jpg', base+baseName+'.jpeg'];
        for(const url of candidates){
          const ok = await loadImage(url);
          if(ok) return url;
        }
        return null;
      }

      function loadImage(url){
        return new Promise(resolve=>{
          const img = new Image();
          img.onload=()=>resolve(true);
            img.onerror=()=>resolve(false);
            img.src=url;
        });
      }

      async function init(){
        const params = parseParams();
        const token = params.access_token || params.token || '';
        let email = params.email || '';
        let avatarClaim = null;
        if(token){
          const decoded = decodeJwt(token);
          if(decoded){
            if(!email && decoded.email) email = decoded.email;
            if(decoded.user_metadata && decoded.user_metadata.avatar_url) {
              avatarClaim = decoded.user_metadata.avatar_url;
            }
          }
        }
        if(email){
          userInfo.classList.remove('hidden');
          emailEl.textContent = email;
          try {
            const avatarUrl = await tryAvatar(email, avatarClaim);
            if(avatarUrl){
              avatarImg.src = avatarUrl;
              avatarImg.style.display='block';
              avatarSkeleton.classList.remove('skeleton');
              avatarStatus.textContent = 'Avatar cargado';
              avatarStatus.classList.add('hidden');
            } else {
              avatarStatus.textContent = 'No se encontró avatar (opcional).';
              avatarSkeleton.classList.remove('skeleton');
            }
          } catch(e){
            errorBox.textContent = 'No se pudo cargar el avatar.';
            errorBox.classList.remove('hidden');
            avatarSkeleton.classList.remove('skeleton');
          }
        } else {
          userInfo.classList.add('hidden');
        }
      }
      
      // Initialize theme and then run original init
      initTheme();
      init();
    })();
  </script>
</body>
</html>
